// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import "forge-std/Script.sol";
import "forge-std/console.sol";
import "../src/MockIDRX.sol";
import "../src/MockUSDC.sol";
import "../src/IdentityRegistry.sol";
import "../src/XAUT.sol";
import "../src/GoldVault.sol";
import "../src/SwapRouter.sol";
import "../src/mocks/MockWETH.sol";
import "../src/mocks/MockUniswapV2Factory.sol";
import "../src/mocks/MockUniswapV2Router.sol";

/**
 * @title Deploy
 * @notice Deployment script for AuRoom protocol on Mantle Testnet
 * @dev Deploys all contracts in correct order with proper initialization
 */
contract Deploy is Script {
    // Initial minting amounts
    uint256 constant INITIAL_IDRX = 1_000_000_000 * 1e18; // 1 billion IDRX
    uint256 constant INITIAL_USDC = 10_000_000 * 1e6;     // 10 million USDC
    uint256 constant INITIAL_XAUT = 100 * 1e6;            // 100 XAUT (6 decimals)

    // Deployed contracts
    MockIDRX public idrx;
    MockUSDC public usdc;
    IdentityRegistry public identityRegistry;
    XAUT public xaut;
    GoldVault public goldVault;
    SwapRouter public swapRouter;

    // Mock Uniswap contracts
    MockWETH public weth;
    MockUniswapV2Factory public uniswapFactory;
    MockUniswapV2Router public uniswapRouter;

    // Deployer address
    address public deployer;

    function run() external {
        // Get deployer address from private key
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        deployer = vm.addr(deployerPrivateKey);

        console.log("==============================================");
        console.log("Starting AuRoom Protocol Deployment");
        console.log("==============================================");
        console.log("Deployer:", deployer);
        console.log("Network: Mantle Testnet");
        console.log("Chain ID:", block.chainid);
        console.log("==============================================\n");

        vm.startBroadcast(deployerPrivateKey);

        // STEP 0: Deploy Mock Uniswap Infrastructure
        console.log("Step 0: Deploying Mock Uniswap Infrastructure...");
        console.log("(Note: Using mock contracts since FusionX not available on Mantle Sepolia)\n");

        uint256 gasStart = gasleft();
        weth = new MockWETH();
        console.log("  MockWETH deployed at:", address(weth));

        uniswapFactory = new MockUniswapV2Factory();
        console.log("  MockUniswapV2Factory deployed at:", address(uniswapFactory));

        uniswapRouter = new MockUniswapV2Router(address(uniswapFactory), address(weth));
        uint256 gasUsed = gasStart - gasleft();
        console.log("  MockUniswapV2Router deployed at:", address(uniswapRouter));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 1: Deploy MockIDRX
        console.log("Step 1: Deploying MockIDRX...");
        gasStart = gasleft();
        idrx = new MockIDRX();
        gasUsed = gasStart - gasleft();
        console.log("  MockIDRX deployed at:", address(idrx));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 2: Deploy MockUSDC
        console.log("Step 2: Deploying MockUSDC...");
        gasStart = gasleft();
        usdc = new MockUSDC();
        gasUsed = gasStart - gasleft();
        console.log("  MockUSDC deployed at:", address(usdc));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 3: Deploy IdentityRegistry
        console.log("Step 3: Deploying IdentityRegistry...");
        gasStart = gasleft();
        identityRegistry = new IdentityRegistry();
        gasUsed = gasStart - gasleft();
        console.log("  IdentityRegistry deployed at:", address(identityRegistry));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 4: Deploy XAUT
        console.log("Step 4: Deploying XAUT...");
        gasStart = gasleft();
        xaut = new XAUT(address(identityRegistry));
        gasUsed = gasStart - gasleft();
        console.log("  XAUT deployed at:", address(xaut));
        console.log("  Parameters:");
        console.log("    - identityRegistry:", address(identityRegistry));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 5: Deploy GoldVault
        console.log("Step 5: Deploying GoldVault...");
        gasStart = gasleft();
        goldVault = new GoldVault(
            address(xaut),
            address(identityRegistry),
            address(uniswapRouter),
            address(usdc)
        );
        gasUsed = gasStart - gasleft();
        console.log("  GoldVault deployed at:", address(goldVault));
        console.log("  Parameters:");
        console.log("    - xaut:", address(xaut));
        console.log("    - identityRegistry:", address(identityRegistry));
        console.log("    - uniswapRouter:", address(uniswapRouter));
        console.log("    - usdc:", address(usdc));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // STEP 6: Deploy SwapRouter
        console.log("Step 6: Deploying SwapRouter...");
        gasStart = gasleft();
        swapRouter = new SwapRouter(
            address(uniswapRouter),
            address(idrx),
            address(usdc),
            address(xaut)
        );
        gasUsed = gasStart - gasleft();
        console.log("  SwapRouter deployed at:", address(swapRouter));
        console.log("  Parameters:");
        console.log("    - uniswapRouter:", address(uniswapRouter));
        console.log("    - idrx:", address(idrx));
        console.log("    - usdc:", address(usdc));
        console.log("    - xaut:", address(xaut));
        console.log("  Gas used:", gasUsed);
        console.log("");

        // POST-DEPLOYMENT SETUP
        console.log("==============================================");
        console.log("Post-Deployment Setup");
        console.log("==============================================\n");

        // Setup 1: Register deployer in IdentityRegistry
        console.log("Setup 1: Registering deployer in IdentityRegistry...");
        identityRegistry.addAdmin(deployer);
        identityRegistry.registerIdentity(deployer);
        console.log("  Deployer registered and verified:", deployer);
        console.log("");

        // Setup 2: Mint initial IDRX
        console.log("Setup 2: Minting initial IDRX...");
        idrx.mint(deployer, INITIAL_IDRX);
        console.log("  Minted", INITIAL_IDRX / 1e18, "IDRX to:", deployer);
        console.log("  IDRX Balance:", idrx.balanceOf(deployer) / 1e18);
        console.log("");

        // Setup 3: Mint initial USDC
        console.log("Setup 3: Minting initial USDC...");
        usdc.mint(deployer, INITIAL_USDC);
        console.log("  Minted", INITIAL_USDC / 1e6, "USDC to:", deployer);
        console.log("  USDC Balance:", usdc.balanceOf(deployer) / 1e6);
        console.log("");

        // Setup 4: Mint initial XAUT
        console.log("Setup 4: Minting initial XAUT...");
        xaut.mint(deployer, INITIAL_XAUT);
        console.log("  Minted", INITIAL_XAUT / 1e6, "XAUT to:", deployer);
        console.log("  XAUT Balance:", xaut.balanceOf(deployer) / 1e6);
        console.log("");

        vm.stopBroadcast();

        // DEPLOYMENT SUMMARY
        console.log("==============================================");
        console.log("Deployment Summary");
        console.log("==============================================");
        console.log("Mock Uniswap Infrastructure:");
        console.log("  MockWETH:             ", address(weth));
        console.log("  MockUniswapV2Factory: ", address(uniswapFactory));
        console.log("  MockUniswapV2Router:  ", address(uniswapRouter));
        console.log("");
        console.log("Protocol Contracts:");
        console.log("  MockIDRX:             ", address(idrx));
        console.log("  MockUSDC:             ", address(usdc));
        console.log("  IdentityRegistry:     ", address(identityRegistry));
        console.log("  XAUT:                 ", address(xaut));
        console.log("  GoldVault:            ", address(goldVault));
        console.log("  SwapRouter:           ", address(swapRouter));
        console.log("==============================================");
        console.log("Deployer:         ", deployer);
        console.log("Deployer Verified:", identityRegistry.isVerified(deployer));
        console.log("==============================================\n");

        // Save deployment addresses to file
        saveDeploymentAddresses();

        console.log("Deployment completed successfully!");
        console.log("Addresses saved to: deployments/mantle-testnet.json");
    }

    /**
     * @notice Save deployment addresses to JSON file
     * @dev Creates a JSON file with all deployed contract addresses
     */
    function saveDeploymentAddresses() internal {
        string memory json = "deployment";

        // Add network info
        vm.serializeUint(json, "chainId", block.chainid);
        vm.serializeString(json, "network", "mantle-testnet");
        vm.serializeUint(json, "timestamp", block.timestamp);
        vm.serializeAddress(json, "deployer", deployer);

        // Add mock Uniswap addresses
        vm.serializeAddress(json, "MockWETH", address(weth));
        vm.serializeAddress(json, "MockUniswapV2Factory", address(uniswapFactory));
        vm.serializeAddress(json, "MockUniswapV2Router", address(uniswapRouter));

        // Add contract addresses
        vm.serializeAddress(json, "MockIDRX", address(idrx));
        vm.serializeAddress(json, "MockUSDC", address(usdc));
        vm.serializeAddress(json, "IdentityRegistry", address(identityRegistry));
        vm.serializeAddress(json, "XAUT", address(xaut));
        vm.serializeAddress(json, "GoldVault", address(goldVault));
        string memory finalJson = vm.serializeAddress(json, "SwapRouter", address(swapRouter));

        // Write to file
        string memory deploymentDir = string.concat(vm.projectRoot(), "/deployments/");
        if (!vm.isDir(deploymentDir)) {
            vm.createDir(deploymentDir, true);
        }

        string memory filepath = string.concat(deploymentDir, "mantle-testnet.json");
        vm.writeJson(finalJson, filepath);
    }
}
